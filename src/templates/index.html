<!doctype html>
<html lang="en" dir="ltr"> <!-- Default to LTR, will be changed by JS -->
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Title will be set by JS -->
    <title data-translate="page_title">Sahih - Hadith Verification</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Add Bootstrap RTL CSS for Arabic support -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" integrity="sha384-dpuaG1suU0eT09tx5plTaGMLBsfDLzUCCUXOY2j/LSvXYuG6TBreq+8Est2Y9BEo" crossorigin="anonymous" disabled> <!-- Disabled by default -->
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
      :root {
          /* Light Mode Variables */
          --primary-color: #0d6efd;
          --secondary-color: #6c757d;
          --light-bg: #f8f9fa;
          --dark-text: #212529;
          --light-text: #f8f9fa;
          --border-color: #dee2e6;
          --card-bg: #ffffff;
          --navbar-bg: #343a40;
          --shadow-sm: 0 .125rem .25rem rgba(0, 0, 0, .075);
          --shadow-lg: 0 1rem 3rem rgba(0, 0, 0, .175);
          --border-radius: .375rem;
          --input-bg: #ffffff;
          --input-text: #212529;
          --result-bg: #f8f9fa;
          --suggestion-hover-bg: #e9ecef;
          --suggestion-border: #dee2e6;
          --suggestion-bg: #ffffff;
          --metadata-label-color: #212529;
          --metadata-value-color: #6c757d;
          --blockquote-color: #212529;
      }

      html[data-theme="dark"] {
          /* Dark Mode Variables */
          --primary-color: #0d6efd; /* Keep primary color */
          --secondary-color: #adb5bd; /* Lighter gray for text */
          --light-bg: #1a1a1a; /* Dark background */
          --dark-text: #e9ecef; /* Light text */
          --light-text: #e9ecef; /* Light text */
          --border-color: #495057; /* Darker border */
          --card-bg: #2c2c2c; /* Dark card background */
          --navbar-bg: #212529; /* Slightly darker navbar */
          --shadow-sm: 0 .125rem .25rem rgba(0, 0, 0, .15);
          --shadow-lg: 0 1rem 3rem rgba(0, 0, 0, .25);
          --input-bg: #343a40;
          --input-text: #f8f9fa;
          --result-bg: #212529;
          --suggestion-hover-bg: #343a40;
          --suggestion-border: #495057;
          --suggestion-bg: #2c2c2c;
          --metadata-label-color: #e9ecef;
          --metadata-value-color: #adb5bd;
          --blockquote-color: #e9ecef;
      }
      
      html[lang="ar"] body {
          font-family: "Noto Sans Arabic", sans-serif;
      }
      
      html[lang="en"] body {
          font-family: "Poppins", sans-serif;
      }

      body {
          padding-top: 5rem; 
          background-color: var(--light-bg);
          color: var(--dark-text);
          transition: background-color 0.3s ease, color 0.3s ease;
      }
      
      .navbar {
          background-color: var(--navbar-bg) !important;
          box-shadow: var(--shadow-sm);
          transition: background-color 0.3s ease;
      }
      
      .navbar-brand {
          font-weight: 600;
      }
      html[lang="ar"] .navbar-brand {
          font-weight: 700;
      }
      
      #languageToggle, #darkModeToggle {
          font-weight: 600;
          margin-left: 0.5rem; /* Add space between toggles */
      }

      .main-content-wrapper {
          background-color: var(--card-bg);
          border-radius: var(--border-radius);
          box-shadow: var(--shadow-sm);
          padding: 2rem;
          transition: background-color 0.3s ease;
      }
      
      h1 {
          color: var(--primary-color);
          font-weight: 600;
          margin-bottom: 1rem;
      }
      html[lang="ar"] h1 {
          font-weight: 700;
      }
      
      .lead {
          color: var(--secondary-color);
          margin-bottom: 1.5rem;
          transition: color 0.3s ease;
      }
      
      .form-label {
          font-weight: 600;
      }
      html[lang="ar"] .form-label {
          font-weight: 700;
      }
      
      #hadithInput {
          border-color: var(--border-color);
          background-color: var(--input-bg);
          color: var(--input-text);
          min-height: 100px;
          transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
      }
      #hadithInput::placeholder {
          color: var(--secondary-color);
      }
      #hadithInput:focus {
          border-color: var(--primary-color);
          box-shadow: 0 0 0 .25rem rgba(13, 110, 253, .25);
      }
      
      #checkButton {
          font-weight: 600;
          padding: .5rem 1rem;
      }
      
      .result-area {
        margin-top: 2rem;
        padding: 1.5rem;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        background-color: var(--result-bg);
        min-height: 100px;
        transition: background-color 0.3s ease, border-color 0.3s ease;
      }
      .result-area .text-muted {
          color: var(--secondary-color) !important;
      }
      
      #suggestionsList {
          border: 1px solid var(--suggestion-border);
          border-radius: var(--border-radius);
          box-shadow: var(--shadow-sm);
          max-height: 250px;
          overflow-y: auto;
          background-color: var(--suggestion-bg);
          transition: background-color 0.3s ease, border-color 0.3s ease;
      }
      #suggestionsList .list-group-item {
          cursor: pointer;
          border: none;
          border-bottom: 1px solid var(--suggestion-border);
          padding: .75rem 1rem;
          background-color: var(--suggestion-bg);
          color: var(--dark-text);
          transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
      }
      #suggestionsList .list-group-item:last-child {
          border-bottom: none;
      }
      #suggestionsList .list-group-item:hover {
          background-color: var(--suggestion-hover-bg);
      }
      
      html[dir="rtl"] #suggestionsList {
          right: 0; 
          left: auto;
      }
      
      .card {
          border: none;
          box-shadow: var(--shadow-sm);
          margin-bottom: 1.5rem !important;
          background-color: var(--card-bg);
          transition: background-color 0.3s ease;
      }
      .card-header {
          background-color: var(--primary-color);
          color: #ffffff; /* Always white text on primary color */
          font-weight: 600;
          border-bottom: none;
      }
      html[lang="ar"] .card-header {
          font-weight: 700;
      }
      .card-body {
          padding: 1.5rem;
      }
      .blockquote p {
          font-size: 1.1em;
          line-height: 1.6;
          margin-bottom: 1rem;
          color: var(--blockquote-color);
          transition: color 0.3s ease;
      }
      .metadata-grid {
          display: grid;
          grid-template-columns: auto 1fr;
          gap: 8px 15px;
          margin-top: 1rem;
          font-size: 0.9em;
          color: var(--metadata-value-color);
          border-top: 1px solid var(--border-color);
          padding-top: 1rem;
          transition: color 0.3s ease, border-color 0.3s ease;
      }
      .metadata-label {
          font-weight: 600;
          color: var(--metadata-label-color);
          transition: color 0.3s ease;
      }
      html[lang="ar"] .metadata-label {
          font-weight: 700;
      }
      
      .alert {
          border-radius: var(--border-radius);
      }
      html[data-theme="dark"] .alert-success {
          background-color: #0a3622; 
          color: #75b798;
          border-color: #0e4b30;
      }
      html[data-theme="dark"] .alert-warning {
          background-color: #332701;
          color: #ffda6a;
          border-color: #4d3a02;
      }
      html[data-theme="dark"] .alert-danger {
          background-color: #340a11;
          color: #ea868f;
          border-color: #50111b;
      }
      html[data-theme="dark"] .btn-close {
          filter: invert(1) grayscale(100%) brightness(200%);
      }
      
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="#" data-translate="navbar_brand">Sahih</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarCollapse">
          <ul class="navbar-nav ms-auto mb-2 mb-md-0"> 
            <li class="nav-item">
              <button id="darkModeToggle" class="btn btn-outline-light">
                <i class="bi bi-moon-stars-fill"></i> <!-- Moon icon for dark mode -->
              </button>
            </li>
            <li class="nav-item">
              <button id="languageToggle" class="btn btn-outline-light" data-translate="language_toggle">العربية</button>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <main class="container mt-4"> 
      <div class="main-content-wrapper"> 
        <h1 data-translate="main_title">Verify a Hadith</h1>
        <p class="lead" data-translate="lead_text">Enter the text of a Hadith below to check its authenticity and get the correct wording. Start typing for suggestions.</p>
        <div class="mb-3 position-relative"> 
          <label for="hadithInput" class="form-label" data-translate="input_label">Hadith Text</label>
          <textarea class="form-control" id="hadithInput" rows="4" placeholder="Start typing Hadith text here..." data-translate-placeholder="input_placeholder"></textarea> 
          <div id="suggestionsList" class="list-group position-absolute w-100" style="z-index: 1000; top: 100%;"></div> 
        </div>
        <button id="checkButton" class="btn btn-primary btn-lg" data-translate="check_button">Check Hadith</button> 
        
        <div id="resultArea" class="result-area mt-4">
          <p class="text-muted" data-translate="results_placeholder">Enter a Hadith and click "Check Hadith" to see the results.</p>
        </div>
        <div id="notificationArea" class="mt-3"></div>
      </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
      console.log("Script block started."); // DEBUG
      // --- JS Variables --- 
      const checkButton = document.getElementById("checkButton");
      const hadithInput = document.getElementById("hadithInput");
      const resultArea = document.getElementById("resultArea");
      const notificationArea = document.getElementById("notificationArea");
      const suggestionsList = document.getElementById("suggestionsList");
      const languageToggleButton = document.getElementById("languageToggle");
      const darkModeToggleButton = document.getElementById("darkModeToggle"); // Dark mode button
      const bootstrapRtlLink = document.querySelector("link[href*='bootstrap.rtl.min.css']");
      let suggestionFetchTimeout;
      let currentLang = "en"; // Default language
      let currentTheme = "light"; // Default theme
      let translations = {}; // To store loaded translations

      // --- Theme Logic --- 
      function applyTheme(theme) {
          console.log(`Applying theme: ${theme}`); // DEBUG
          document.documentElement.setAttribute("data-theme", theme);
          currentTheme = theme;
          // Update toggle button icon
          const toggleButton = document.getElementById("darkModeToggle"); // Get button inside function
          if (toggleButton) {
              toggleButton.innerHTML = theme === "dark" 
                  ? `<i class="bi bi-sun-fill"></i>` // Sun icon for light mode
                  : `<i class="bi bi-moon-stars-fill"></i>`; // Moon icon for dark mode
          }
      }

      // --- Localization Logic --- 
      async function loadTranslations(lang) {
          console.log(`Loading translations for: ${lang}`); // DEBUG
          try {
              const response = await fetch(`/locales/${lang}.json`);
              console.log(`Fetch status for ${lang}.json: ${response.status}`); // DEBUG
              if (!response.ok) {
                  throw new Error(`HTTP error! status: ${response.status}`);
              }
              translations = await response.json();
              console.log(`Translations loaded for ${lang}:`, translations); // DEBUG
              applyTranslations(lang);
          } catch (error) {
              console.error(`Error loading translations for ${lang}:`, error);
          }
      }

      function applyTranslations(lang) {
          console.log(`Applying translations for: ${lang}`); // DEBUG
          document.documentElement.lang = lang;
          document.documentElement.dir = lang === "ar" ? "rtl" : "ltr";
          if (bootstrapRtlLink) { 
             bootstrapRtlLink.disabled = lang !== "ar";
          } else {
             console.error("Bootstrap RTL link not found");
          }

          document.querySelectorAll("[data-translate]").forEach(element => {
              const key = element.getAttribute("data-translate");
              if (translations[key]) {
                  element.textContent = translations[key];
              } else {
                  console.warn(`Translation key not found: ${key}`); // DEBUG
              }
          });
          document.querySelectorAll("[data-translate-placeholder]").forEach(element => {
              const key = element.getAttribute("data-translate-placeholder");
              if (translations[key]) {
                  element.placeholder = translations[key];
              } else {
                  console.warn(`Placeholder translation key not found: ${key}`); // DEBUG
              }
          });
          const titleElement = document.querySelector("title[data-translate]");
          if (titleElement) {
              const titleKey = titleElement.getAttribute("data-translate");
              if (titleKey && translations[titleKey]) {
                  document.title = translations[titleKey];
              } else {
                  console.warn(`Title translation key not found: ${titleKey}`); // DEBUG
              }
          }
          // Apply translations to dynamically generated content if needed (e.g., results)
          // This might require re-rendering the result area if it's already populated
          const existingResultCard = resultArea.querySelector('.card');
          if (existingResultCard && existingResultCard.dataset.hadithData) {
              try {
                  const hadithData = JSON.parse(existingResultCard.dataset.hadithData);
                  displayHadithResult(hadithData); // Re-render with new translations
              } catch (e) {
                  console.error("Error re-rendering result card:", e);
              }
          }
          console.log(`Translations applied for: ${lang}`); // DEBUG
      }

      function getTranslation(key, replacements = {}) {
          let text = translations[key] || key; 
          for (const placeholder in replacements) {
              text = text.replace(`{${placeholder}}`, replacements[placeholder]);
          }
          return text;
      }

      if (languageToggleButton) { 
          languageToggleButton.addEventListener("click", () => {
              console.log("Language toggle button clicked."); // DEBUG
              currentLang = currentLang === "en" ? "ar" : "en";
              localStorage.setItem("preferredLang", currentLang);
              loadTranslations(currentLang);
          });
      } else {
          console.error("Language toggle button not found");
      }

      // --- Autocomplete Suggestion Logic --- 
      if (hadithInput) { 
          hadithInput.addEventListener("input", () => {
              const query = hadithInput.value.trim();
              clearTimeout(suggestionFetchTimeout);
              if (query.length < 3) {
                  if(suggestionsList) suggestionsList.innerHTML = "";
                  return;
              }
              suggestionFetchTimeout = setTimeout(async () => {
                  console.log(`Fetching suggestions for: ${query}`); // DEBUG
                  try {
                      const response = await fetch(`/suggest?q=${encodeURIComponent(query)}&limit=5`);
                      console.log(`Suggest API response status: ${response.status}`); // DEBUG
                      if (!response.ok) {
                          throw new Error(`HTTP error! status: ${response.status}`);
                      }
                      const suggestions = await response.json();
                      console.log("Suggestions received:", suggestions); // DEBUG
                      if (suggestions.error) {
                         console.error("Suggestion API Error:", suggestions.error);
                         if(suggestionsList) suggestionsList.innerHTML = "";
                      } else {
                         displaySuggestions(suggestions);
                      }
                  } catch (error) {
                      console.error(getTranslation("error_fetching_suggestions"), error);
                      if(suggestionsList) suggestionsList.innerHTML = "";
                  }
              }, 300);
          });
      } else {
          console.error("Hadith input element not found");
      }

      function displaySuggestions(suggestions) {
          if (!suggestionsList) return;
          suggestionsList.innerHTML = "";
          if (!Array.isArray(suggestions) || suggestions.length === 0) {
              return;
          }
          suggestions.forEach(suggestionText => {
              const item = document.createElement("button");
              item.type = "button";
              item.classList.add("list-group-item", "list-group-item-action");
              item.textContent = suggestionText;
              item.lang = "ar"; 
              item.dir = "rtl";
              item.addEventListener("click", () => {
                  if(hadithInput) hadithInput.value = suggestionText;
                  if(suggestionsList) suggestionsList.innerHTML = "";
                  if(hadithInput) hadithInput.focus();
              });
              suggestionsList.appendChild(item);
          });
      }

      document.addEventListener("click", (event) => {
          if (hadithInput && suggestionsList && !hadithInput.contains(event.target) && !suggestionsList.contains(event.target)) {
              suggestionsList.innerHTML = "";
          }
      });

      // --- Check Hadith Logic --- 
      if (checkButton) { 
          checkButton.addEventListener("click", async () => {
            console.log("Check Hadith button clicked."); // DEBUG
            const inputText = hadithInput ? hadithInput.value.trim() : "";
            if(suggestionsList) suggestionsList.innerHTML = "";
            if(resultArea) resultArea.innerHTML = `<p class="text-muted">${getTranslation("checking_message")}</p>`;
            if(notificationArea) notificationArea.innerHTML = "";

            if (!inputText) {
              if(resultArea) resultArea.innerHTML = `<p class="text-danger">${getTranslation("error_no_text")}</p>`;
              return;
            }

            console.log(`Checking Hadith: ${inputText}`); // DEBUG
            try {
              const response = await fetch("/check", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ text: inputText })
              });
              console.log(`Check API response status: ${response.status}`); // DEBUG

              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }

              const data = await response.json();
              console.log("Check API response data:", data); // DEBUG
              if(resultArea) resultArea.innerHTML = ""; 

              if (data.error) {
                  showNotification(getTranslation("notification_error"), "danger");
                  if(resultArea) resultArea.innerHTML = `<p class="text-danger">${getTranslation("error_server_comm")}</p>`;
                  console.error("Check API Error:", data.error);
              } else if (data.found) {
                showNotification(getTranslation("notification_found"), "success");
                displayHadithResult(data);
              } else {
                showNotification(getTranslation("notification_not_found"), "warning");
                if(resultArea) resultArea.innerHTML = `<p class="text-warning">${getTranslation("no_match_warning")}</p>`;
              }

            } catch (error) {
              console.error("Error checking Hadith:", error);
              showNotification(getTranslation("notification_error"), "danger");
              if(resultArea) resultArea.innerHTML = `<p class="text-danger">${getTranslation("error_server_comm")}</p>`;
            }
          });
      } else {
          console.error("Check Hadith button not found");
      }
      
      function displayHadithResult(data) {
          if (!resultArea) return;
          resultArea.innerHTML = ''; // Clear previous results
          const hadithElement = document.createElement("div");
          hadithElement.classList.add("card", "mb-3");
          // Store data for potential re-rendering on language change
          hadithElement.dataset.hadithData = JSON.stringify(data);
          
          // Language/direction will be inherited from the html tag
          // hadithElement.lang = contentLang;
          // hadithElement.dir = "rtl";
          
          let innerHTML = `
            <div class="card-header">
              ${data.source || 'N/A'} - ${data.reference || 'N/A'}
            </div>
            <div class="card-body">
              <blockquote class="blockquote mb-0">
                <p>${data.hadith_text || 'N/A'}</p>
              </blockquote>
              <div class="metadata-grid">
                  <span class="metadata-label">${getTranslation('metadata_narrator')}:</span> <span>${data.narrator || 'N/A'}</span>
                  <span class="metadata-label">${getTranslation('metadata_scholar')}:</span> <span>${data.scholar || 'N/A'}</span>
                  <span class="metadata-label">${getTranslation('metadata_source')}:</span> <span>${data.source || 'N/A'}</span>
                  <span class="metadata-label">${getTranslation('metadata_reference')}:</span> <span>${data.reference || 'N/A'}</span>
                  <span class="metadata-label">${getTranslation('metadata_grade')}:</span> <span>${data.grade || 'N/A'}</span>
              </div>
            </div>
          `;
          
          hadithElement.innerHTML = innerHTML;
          resultArea.appendChild(hadithElement);
          
          if (data.more_results_available) {
              const moreInfo = document.createElement("p");
              moreInfo.classList.add("text-muted", "mt-2");
              moreInfo.textContent = getTranslation('more_results_info');
              resultArea.appendChild(moreInfo);
          }
      }

      // --- Show Notification Logic --- 
      function showNotification(message, type) {
          if (!notificationArea) return;
          const alertDiv = document.createElement("div");
          alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
          alertDiv.role = "alert";
          alertDiv.innerHTML = `
              ${message}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          `;
          alertDiv.dir = document.documentElement.dir;
          notificationArea.innerHTML = "";
          notificationArea.appendChild(alertDiv);
      }
      
      // --- Initial Load --- 
      document.addEventListener("DOMContentLoaded", () => {
          console.log("DOMContentLoaded event fired."); // DEBUG

          // --- Language Detection ---
          let initialLang = localStorage.getItem("preferredLang");
          if (!initialLang) {
              // Detect browser language if no preference is stored
              const browserLang = navigator.language || navigator.userLanguage; // Get browser language
              console.log(`Detected browser language: ${browserLang}`); // DEBUG
              if (browserLang && browserLang.toLowerCase().startsWith("ar")) {
                  initialLang = "ar";
              } else {
                  initialLang = "en"; // Default to English
              }
          }
          currentLang = initialLang;
          console.log(`Initial language set to: ${currentLang}`); // DEBUG
          loadTranslations(currentLang); // Load translations for the determined language

          // --- Theme Loading & Toggle Setup ---
          const preferredTheme = localStorage.getItem("preferredTheme") || "light"; // Default to light
          applyTheme(preferredTheme);
          console.log(`Initial theme set to: ${preferredTheme}`); // DEBUG

          // Attach dark mode toggle listener after DOM is loaded
          const darkModeToggleButton = document.getElementById("darkModeToggle");
          if (darkModeToggleButton) {
              darkModeToggleButton.addEventListener("click", () => {
                  console.log("Dark mode toggle clicked."); // DEBUG
                  const newTheme = currentTheme === "light" ? "dark" : "light";
                  localStorage.setItem("preferredTheme", newTheme);
                  applyTheme(newTheme);
              });
          } else {
              console.error("Dark mode toggle button not found after DOM load");
          }
      });
      console.log("Script block finished."); // DEBUG
    </script>
  </body>
</html>
